typedef int vmm_spinlock_t;typedef int u64;typedef int u16;typedef int bool;typedef int arch_regs_t;typedef int vmm_rwlock_t;typedef int resource_size_t;typedef int loff_t;typedef int irq_flags_t;typedef int u32;typedef int pthread_t;typedef int vmm_scheduler_ctrl;typedef int virtual_addr_t;typedef int u8;typedef int virtual_size_t;typedef int physical_addr_t;typedef int physical_size_t;typedef int atomic_t;typedef int vmm_iommu_fault_handler_t;typedef int dma_addr_t;typedef int size_t;typedef int off_t;typedef int vmm_dr_release_t;typedef int vmm_dr_match_t;typedef int vmm_clocksource_init_t;typedef int s64;typedef int va_list;typedef int vmm_host_irq_handler_t;typedef int vmm_host_irq_function_t;typedef int vmm_host_irq_init_t;typedef int Elf_Ehdr;typedef int Elf_Shdr;typedef int Elf_Sym;typedef int s16;typedef int vmm_clockchip_init_t;typedef int pthread_spinlock_t;




static int notifier_chain_register(struct vmm_notifier_block **nl,
				   struct vmm_notifier_block *n)
{
	while ((*nl) != NULL) {
		if (n->priority > (*nl)->priority)
			break;
		nl = &((*nl)->next);
	}
	n->next = *nl;
	*nl = n;
	return VMM_OK;
}

static int notifier_chain_cond_register(struct vmm_notifier_block **nl,
					struct vmm_notifier_block *n)
{
	while ((*nl) != NULL) {
		if ((*nl) == n)
			return VMM_OK;
		if (n->priority > (*nl)->priority)
			break;
		nl = &((*nl)->next);
	}
	n->next = *nl;
	*nl = n;
	return VMM_OK;
}

static int notifier_chain_unregister(struct vmm_notifier_block **nl,
				     struct vmm_notifier_block *n)
{
	while ((*nl) != NULL) {
		if ((*nl) == n) {
			*nl = n->next;
			return VMM_OK;
		}
		nl = &((*nl)->next);
	}
	return VMM_ENOENT;
}

static int notifier_call_chain(struct vmm_notifier_block **nl,
				unsigned long val, void *v,
				int nr_to_call,	int *nr_calls)
{
	int ret = NOTIFY_DONE;
	struct vmm_notifier_block *nb, *next_nb;

	nb = *nl;

	while (nb && nr_to_call) {
		next_nb = nb->next;

		ret = nb->notifier_call(nb, val, v);

		if (nr_calls)
			(*nr_calls)++;

		if ((ret & NOTIFY_STOP_MASK) == NOTIFY_STOP_MASK)
			break;
		nb = next_nb;
		nr_to_call--;
	}

	return ret;
}



int vmm_atomic_notifier_register(struct vmm_atomic_notifier_chain *nc,
				 struct vmm_notifier_block *n)
{
	irq_flags_t flags;
	int ret;

	vmm_spin_lock_irqsave(&nc->lock, flags);
	ret = notifier_chain_register(&nc->head, n);
	vmm_spin_unlock_irqrestore(&nc->lock, flags);

	return ret;
}

int vmm_atomic_notifier_unregister(struct vmm_atomic_notifier_chain *nc,
				   struct vmm_notifier_block *n)
{
	irq_flags_t flags;
	int ret;

	vmm_spin_lock_irqsave(&nc->lock, flags);
	ret = notifier_chain_unregister(&nc->head, n);
	vmm_spin_unlock_irqrestore(&nc->lock, flags);

	return ret;
}

int __vmm_atomic_notifier_call(struct vmm_atomic_notifier_chain *nc,
				unsigned long val, void *v,
				int nr_to_call, int *nr_calls)
{
	irq_flags_t flags;
	int ret;

	vmm_spin_lock_irqsave(&nc->lock, flags);
	ret = notifier_call_chain(&nc->head, val, v, nr_to_call, nr_calls);
	vmm_spin_unlock_irqrestore(&nc->lock, flags);

	return ret;
}

int vmm_atomic_notifier_call(struct vmm_atomic_notifier_chain *nc,
			     unsigned long val, void *v)
{
	return __vmm_atomic_notifier_call(nc, val, v, -1, NULL);
}



int vmm_blocking_notifier_register(struct vmm_blocking_notifier_chain *nc,
				   struct vmm_notifier_block *n)
{
	int ret;

	vmm_semaphore_down(&nc->rwsem);
	ret = notifier_chain_register(&nc->head, n);
	vmm_semaphore_up(&nc->rwsem);

	return ret;
}

int vmm_blocking_notifier_cond_register(struct vmm_blocking_notifier_chain *nc,
					struct vmm_notifier_block *n)
{
	int ret;

	vmm_semaphore_down(&nc->rwsem);
	ret = notifier_chain_cond_register(&nc->head, n);
	vmm_semaphore_up(&nc->rwsem);

	return ret;
}

int vmm_blocking_notifier_unregister(struct vmm_blocking_notifier_chain *nc,
				     struct vmm_notifier_block *n)
{
	int ret;

	vmm_semaphore_down(&nc->rwsem);
	ret = notifier_chain_unregister(&nc->head, n);
	vmm_semaphore_up(&nc->rwsem);

	return ret;
}

int __vmm_blocking_notifier_call(struct vmm_blocking_notifier_chain *nc,
				 unsigned long val, void *v,
				 int nr_to_call, int *nr_calls)
{
	int ret = NOTIFY_DONE;

	vmm_semaphore_down(&nc->rwsem);
	ret = notifier_call_chain(&nc->head, val, v, nr_to_call, nr_calls);
	vmm_semaphore_up(&nc->rwsem);

	return ret;
}

int vmm_blocking_notifier_call(struct vmm_blocking_notifier_chain *nc,
				unsigned long val, void *v)
{
	return __vmm_blocking_notifier_call(nc, val, v, -1, NULL);
}



int vmm_raw_notifier_register(struct vmm_raw_notifier_chain *nc,
			      struct vmm_notifier_block *n)
{
	return notifier_chain_register(&nc->head, n);
}

int vmm_raw_notifier_unregister(struct vmm_raw_notifier_chain *nc,
				struct vmm_notifier_block *n)
{
	return notifier_chain_unregister(&nc->head, n);
}

int __vmm_raw_notifier_call(struct vmm_raw_notifier_chain *nc,
			    unsigned long val, void *v,
			    int nr_to_call, int *nr_calls)
{
	return notifier_call_chain(&nc->head, val, v, nr_to_call, nr_calls);
}

int vmm_raw_notifier_call(struct vmm_raw_notifier_chain *nc,
			  unsigned long val, void *v)
{
	return __vmm_raw_notifier_call(nc, val, v, -1, NULL);
}

